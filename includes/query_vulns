#!/usr/bin/env bash
set -eo pipefail

# shellcheck disable=SC2016
VULNS_JSON_JQ='
.data.search.edges[] | .node.vulnerabilityAlerts.nodes.[] |
{
    "repository": .repository.nameWithOwner,
    "package": .securityVulnerability.package.name,
		"severity": .securityVulnerability.severity,
		"CVE": .securityAdvisory.identifiers[] | select(.type == "CVE") | .value,
    "url": "http://github.com/\(.repository.nameWithOwner)/security/dependabot/\(.number)",
    "createdAt": .createdAt
}
'

# shellcheck disable=SC2016
VULNS_REPORT_TEMPLATE='
{{tablerow "Repository" "Package" "CVE" "Severity" "URL" "Created" -}}
{{range(pluck "node" .data.search.edges) -}}
{{range .vulnerabilityAlerts.nodes -}}
{{ $url:= printf "https://github.com/%s/security/dependabot/%v" .repository.nameWithOwner .number -}}
{{ $cve:= "❓❓" -}}
{{range .securityAdvisory.identifiers -}}
  {{ if eq .type "CVE" -}}
    {{ $cve = .value -}}
  {{ end -}}
{{ end -}}
{{tablerow (.repository.nameWithOwner | autocolor "green")
          (.securityVulnerability.package.name | autocolor "cyan")
					($cve | autocolor "yellow")
					(.securityVulnerability.severity)
          ($url | autocolor "yellow")
          (timeago .createdAt) -}}
{{end -}}
{{end -}}
'
# shellcheck disable=SC2016
VULNS_GRAPHQL_QUERY='
query($searchQuery: String!, $endCursor: String) {
  search(query: $searchQuery, type: REPOSITORY, first: 100, after: $endCursor) {
    edges {
      node {
        ... on Repository {
          nameWithOwner
          vulnerabilityAlerts(first: 100, states:OPEN) {
            nodes {
              createdAt
              vulnerableManifestPath
              vulnerableManifestFilename
              number
              repository {
                nameWithOwner
              }
              securityVulnerability {
                package {
                  name
                }
								severity
              }
							securityAdvisory {
								ghsaId
							  identifiers {
									type
									value
								}
							}
            }
          }
        }
      }
    }
    pageInfo {
      hasNextPage
      endCursor
    }
  }
}
'

query_vulns() {

  local owner""
  local repo=""
  local output_format="table"
  owner=$(helper::gh_whoami)
  if helper::is_repo; then
    repo=$(helper::repo_info)
  fi
  while getopts 'o:ja' flag; do
    case "${flag}" in
    j) output_format="json" ;;
    o)
      # Explicit owner then you know what you're doing?
      owner="${OPTARG}"
      repo=""
      ;;
    a) repo="" ;;
    *) query_help ;;
    esac
  done

  local queryString=""

  if [[ -n "$repo" ]]; then
    queryString="repo:$repo"
  else
    queryString="owner:$owner fork:true archived:false"
  fi
  case $output_format in
  json)
    gh api graphql --paginate -F searchQuery="$queryString" --raw-field query="$(helper::compressQuery "$VULNS_GRAPHQL_QUERY")" --jq="$VULNS_JSON_JQ" | jq -c "."
    ;;
  *)
    gh api graphql --paginate -F searchQuery="$queryString" --raw-field query="$(helper::compressQuery "$VULNS_GRAPHQL_QUERY")" --template="$VULNS_REPORT_TEMPLATE"
    # gh api graphql --paginate -F searchQuery="$queryString" --raw-field query="$(helper::compressQuery "$VULNS_GRAPHQL_QUERY")"
    ;;
  esac
}
